<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>  ERPNext Account Statement </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@300;400;500;600;700&family=JetBrains+Mono:wght@500;700&display=swap');
        
        body { 
            font-family: 'IBM Plex Sans Arabic', sans-serif; 
            background-color: #f8fafc; 
        }
        .mono { font-family: 'JetBrains Mono', monospace; }
        
        input[type="checkbox"] {
            width: 1.1rem;
            height: 1.1rem;
            cursor: pointer;
            accent-color: #0f172a;
        }

        .filter-label { font-size: 11px; font-weight: 500; color: #475569; }

        /* تلوين ديناميكي للرصيد النهائي */
        .balance-dr { background-color: #1e3a8a; color: #f8fafc; border-bottom: 4px solid #3b82f6; }
        .balance-cr { background-color: #7f1d1d; color: #fef2f2; border-bottom: 4px solid #ef4444; }

        @media print {
            .no-print { display: none !important; }
            .print-container { max-width: 100% !important; border: none !important; shadow: none !important; }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-[1300px] mx-auto print-container">
        
        <header class="bg-white border-b-2 border-slate-900 p-6 flex justify-between items-center rounded-t-xl shadow-sm">
            <div class="flex items-center gap-4">
                <div class="bg-slate-900 p-2.5 rounded-lg text-white">
                    <i data-lucide="bar-chart-3" class="w-7 h-7"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-slate-900"> ERPNext Account Statement </h1>
                    <p class="text-slate-400 text-[10px] font-mono uppercase tracking-widest">Financial Management System</p>
                </div>
            </div>
            <div class="flex gap-2 no-print">
                <button onclick="window.print()" class="bg-slate-50 border border-slate-200 px-4 py-2 rounded text-xs font-bold hover:bg-slate-100 transition-all flex items-center gap-2">
                    <i data-lucide="download-cloud" class="w-4 h-4"></i> تصدير التقرير
                </button>
            </div>
        </header>

        <div class="no-print bg-white border-x border-b border-slate-200 p-6 shadow-sm mb-6 rounded-b-xl">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                <div class="space-y-1.5">
                    <label class="text-[10px] font-bold text-slate-500 uppercase">الطرف المعني / الحساب</label>
                    <select id="partyFilter" onchange="applyFilters()" class="w-full bg-slate-50 border border-slate-200 rounded p-2 text-xs focus:ring-1 focus:ring-slate-900 outline-none">
                        <option value="">كافة الأطراف والحسابات</option>
                    </select>
                </div>
                <div class="space-y-1.5">
                    <label class="text-[10px] font-bold text-slate-500 uppercase">من تاريخ</label>
                    <input type="date" id="dateFrom" onchange="applyFilters()" class="w-full bg-slate-50 border border-slate-200 rounded p-2 text-xs outline-none">
                </div>
                <div class="space-y-1.5">
                    <label class="text-[10px] font-bold text-slate-500 uppercase">إلى تاريخ</label>
                    <input type="date" id="dateTo" onchange="applyFilters()" class="w-full bg-slate-50 border border-slate-200 rounded p-2 text-xs outline-none">
                </div>
                <div class="space-y-1.5">
                    <label class="text-[10px] font-bold text-slate-500 uppercase">نمط العرض (View Mode)</label>
                    <select id="viewMode" onchange="applyFilters()" class="w-full bg-blue-50 border border-blue-200 rounded p-2 text-xs font-bold text-blue-900 focus:ring-1 focus:ring-blue-500 outline-none">
                        <option value="voucher">Categorize by Voucher</option>
                        <option value="consolidated" selected>Categorize by Voucher (Consolidated)</option>
                        <option value="account">Categorize by Account</option>
                        <option value="party">Categorize by Party</option>
                    </select>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-y-4 gap-x-8 border-t border-slate-50 pt-6">
                <div class="flex flex-col gap-3">
                    <label class="flex items-center gap-3"><input type="checkbox" checked><span class="filter-label">ضع في اعتبارك أبعاد المحاسبة</span></label>
                    <label class="flex items-center gap-3"><input type="checkbox"><span class="filter-label">إضافة أعمدة في عملة المعاملات</span></label>
                </div>
                <div class="flex flex-col gap-3">
                    <label class="flex items-center gap-3"><input type="checkbox"><span class="filter-label">Show Opening Entries</span></label>
                    <label class="flex items-center gap-3"><input type="checkbox" checked id="showRemarks"><span class="filter-label">Show Remarks</span></label>
                </div>
                <div class="flex flex-col gap-3">
                    <label class="flex items-center gap-3"><input type="checkbox" checked><span class="filter-label">تضمين إدخالات دفتر افتراضي</span></label>
                    <label class="flex items-center gap-3"><input type="checkbox" checked><span class="filter-label">Ignore System Generated Notes</span></label>
                </div>
                <div class="flex flex-col gap-3">
                    <label class="flex items-center gap-3"><input type="checkbox"><span class="filter-label">Show Cancelled Entries</span></label>
                    <label class="flex items-center gap-3"><input type="checkbox" checked><span class="filter-label">Ignore Exchange Journals</span></label>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="bg-white p-5 border border-slate-200 rounded-xl shadow-sm">
                <span class="text-[10px] font-bold text-emerald-600 block mb-1">Total Debit</span>
                <p id="totalDr" class="text-2xl font-black text-slate-800 mono">0.00</p>
            </div>
            <div class="bg-white p-5 border border-slate-200 rounded-xl shadow-sm">
                <span class="text-[10px] font-bold text-rose-600 block mb-1">Total Credit</span>
                <p id="totalCr" class="text-2xl font-black text-slate-800 mono">0.00</p>
            </div>
            <div id="balanceCard" class="p-5 rounded-xl shadow-lg transition-colors duration-500">
                <span class="text-[10px] font-bold opacity-80 block mb-1 uppercase tracking-widest">Net Closing Balance</span>
                <p id="finalBal" class="text-2xl font-black mono">0.00</p>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <table class="w-full text-right border-collapse">
                <thead class="bg-slate-50 border-b border-slate-200">
                    <tr class="text-slate-500 font-bold text-[10px] uppercase">
                        <th id="groupHeader" class="p-4 text-slate-900">رقم المرجع / المجموعة</th>
                        <th class="p-4">التاريخ</th>
                        <th class="p-4">تفاصيل المعاملة</th>
                        <th class="p-4 text-left">مدين</th>
                        <th class="p-4 text-left">دائن</th>
                        <th class="p-4 text-left bg-slate-100/30">الرصيد</th>
                    </tr>
                </thead>
                <tbody id="statementBody" class="text-[12px] divide-y divide-slate-100"></tbody>
            </table>
        </div>
    </div>

    <script>
        // داتابيس موسعة لاختبار كافة أنماط العرض
        const rawEntries = [
            { voucher: 'INV-101', date: '2025-11-01', party: 'أحمد علي', account: 'Account Receivable', desc: 'بيع أجهزة', dr: 5000, cr: 0 },
            { voucher: 'INV-101', date: '2025-11-01', party: 'أحمد علي', account: 'Sales Revenue', desc: 'ضريبة مبيعات', dr: 750, cr: 0 },
            { voucher: 'RCP-502', date: '2025-11-15', party: 'أحمد علي', account: 'Cash', desc: 'سداد جزئي', dr: 0, cr: 2000 },
            { voucher: 'INV-102', date: '2025-12-01', party: 'شركة سكاى ستار', account: 'Account Receivable', desc: 'تراخيص برمجية', dr: 12000, cr: 0 },
            { voucher: 'RCP-503', date: '2025-12-10', party: 'شركة سكاى ستار', account: 'Cash', desc: 'سداد كامل', dr: 0, cr: 12000 }
        ];

        function init() {
            const parties = [...new Set(rawEntries.map(e => e.party))];
            const sel = document.getElementById('partyFilter');
            parties.forEach(p => sel.innerHTML += `<option value="${p}">${p}</option>`);
            applyFilters();
            lucide.createIcons();
        }

        const format = (n) => new Intl.NumberFormat('en-US', { minimumFractionDigits: 2 }).format(n);

        function applyFilters() {
            const mode = document.getElementById('viewMode').value;
            const party = document.getElementById('partyFilter').value;
            const from = document.getElementById('dateFrom').value;
            const to = document.getElementById('dateTo').value;

            let filtered = rawEntries.filter(e => {
                return (!party || e.party === party) && (!from || e.date >= from) && (!to || e.date <= to);
            });

            let displayData = [];
            let groupKey = '';

            // منطق أنماط العرض
            if (mode === 'consolidated') {
                groupKey = 'voucher';
                const grouped = filtered.reduce((acc, curr) => {
                    if (!acc[curr.voucher]) acc[curr.voucher] = { ...curr, desc: 'إجمالي السند الموحد' };
                    else { acc[curr.voucher].dr += curr.dr; acc[curr.voucher].cr += curr.cr; }
                    return acc;
                }, {});
                displayData = Object.values(grouped);
                document.getElementById('groupHeader').innerText = 'رقم السند الموحد';
            } else if (mode === 'account') {
                groupKey = 'account';
                const grouped = filtered.reduce((acc, curr) => {
                    if (!acc[curr.account]) acc[curr.account] = { ...curr, voucher: curr.account, desc: 'تجميع حسب الحساب' };
                    else { acc[curr.account].dr += curr.dr; acc[curr.account].cr += curr.cr; }
                    return acc;
                }, {});
                displayData = Object.values(grouped);
                document.getElementById('groupHeader').innerText = 'الحساب المحاسبي';
            } else if (mode === 'party') {
                groupKey = 'party';
                const grouped = filtered.reduce((acc, curr) => {
                    if (!acc[curr.party]) acc[curr.party] = { ...curr, voucher: curr.party, desc: 'تجميع حسب الطرف' };
                    else { acc[curr.party].dr += curr.dr; acc[curr.party].cr += curr.cr; }
                    return acc;
                }, {});
                displayData = Object.values(grouped);
                document.getElementById('groupHeader').innerText = 'الطرف المعني';
            } else {
                displayData = filtered; // Categorize by Voucher (Detailed)
                document.getElementById('groupHeader').innerText = 'رقم السند';
            }

            render(displayData);
        }

        function render(data) {
            const tbody = document.getElementById('statementBody');
            tbody.innerHTML = '';
            let runningBal = 0, sumDr = 0, sumCr = 0;

            data.sort((a,b) => new Date(a.date) - new Date(b.date)).forEach(row => {
                runningBal += (row.dr - row.cr);
                sumDr += row.dr;
                sumCr += row.cr;

                tbody.innerHTML += `
                    <tr class="hover:bg-slate-50">
                        <td class="p-4 font-bold text-slate-800 mono">${row.voucher}</td>
                        <td class="p-4 text-slate-500 font-medium">${row.date}</td>
                        <td class="p-4">
                            <div class="font-semibold">${row.desc}</div>
                            <div class="text-[9px] text-slate-400 uppercase">${row.party}</div>
                        </td>
                        <td class="p-4 text-left mono font-bold text-emerald-700">${format(row.dr)}</td>
                        <td class="p-4 text-left mono font-bold text-rose-700">${format(row.cr)}</td>
                        <td class="p-4 text-left mono font-black bg-slate-50/50">
                            ${format(Math.abs(runningBal))} <span class="text-[8px] opacity-40">${runningBal >=0 ? 'DR' : 'CR'}</span>
                        </td>
                    </tr>
                `;
            });

            // تحديث الأرقام واللون
            document.getElementById('totalDr').innerText = format(sumDr);
            document.getElementById('totalCr').innerText = format(sumCr);
            
            const balEl = document.getElementById('finalBal');
            const cardEl = document.getElementById('balanceCard');
            
            balEl.innerText = format(Math.abs(runningBal)) + (runningBal >= 0 ? ' DR' : ' CR');
            
            // تغيير اللون بناءً على الحالة
            if (runningBal >= 0) {
                cardEl.className = 'p-5 rounded-xl shadow-lg transition-colors duration-500 balance-dr';
            } else {
                cardEl.className = 'p-5 rounded-xl shadow-lg transition-colors duration-500 balance-cr';
            }
        }

        window.onload = init;
    </script>
</body>
</html>

